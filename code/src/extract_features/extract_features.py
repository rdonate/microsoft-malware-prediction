#! - * - coding UTF-8 - * -

import mmap,re,pickle,os
import numpy as np
from pymongo import IndexModel,ASCENDING


def extract_features(db, dir_Data_Raw, dir_Data, prefix_collections, names_collections):
    lengthDB = 0
    num_line=0
    with open(dir_Data, 'r+b') as file:
        mm = mmap.mmap(file.fileno(), 0)
        name_features = re.split(",", re.sub(r"^b'|\\n'$", "", str(file.readline())))
        isText = set()
        while True:
            line = file.readline()
            if not line or line == "'":
                break
            if line == '':
                continue
            line = re.split(",", re.sub(r"^b'|\\n'$", "", str(line)))
            num_line += 1
            for index, elem in enumerate(line):
                if not elem.isnumeric():
                    if elem.count('.') == 1:
                        aux_elem = re.split('.', elem)
                        if (not (aux_elem[0].isnumeric() and aux_elem[1].isnumeric())) and (not elem==""):
                            isText.add(index)
                    else:
                        isText.add(index)
    if 0 in isText:
        isText.remove(0)
    isTextNames = list()
    for value in isText:
        isTextNames.append(name_features[value])
    if not  os.path.exists(dir_Data_Raw+'/names_features_type'):
        os.mkdir(dir_Data_Raw+'/names_features_type')
    with open(dir_Data_Raw+'/names_features_type/isText'+prefix_collections, 'wb') as file_types:
        pickle.dump(isTextNames,file_types)
    file_types.close()
    del isTextNames, file_types
    colection = db.selectCollection(prefix_collections + '_' + names_collections[0])
    with open(dir_Data, 'r+b') as file:
        mm = mmap.mmap(file.fileno(), 0)
        name_features = re.split(",", re.sub(r"^b'|\\n'$", "", str(file.readline())))
        name_features.append('index')
        isNumerics = list(set(range(len(name_features)))-isText-set([0]))
        isNumericsNames = list()
        for value in isNumerics:
            isNumericsNames.append(name_features[value])
        with open(dir_Data_Raw + '/names_features_type/isNumerics'+prefix_collections, 'wb') as file_types:
            pickle.dump(isNumericsNames, file_types)
        del isNumericsNames, file_types
        while True:
            line = file.readline()
            if not line or line=="'":
                break
            if line == '':
                continue
            aux_line = re.split(",", re.sub(r"^b'|\\n'$", "", str(line)))
            aux_line.append(lengthDB)
            aux_line=np.array(aux_line,dtype=str)
            value = dict()
            try:
                for index in isNumerics:
                    if type(aux_line[index])==int or (type(aux_line[index]) == str and aux_line[index].isnumeric()):
                        value[name_features[index]]=int(aux_line[index])
                    else:
                        value[name_features[index]] = float(aux_line[index])
                value_text=""
                value_text_without_name_feaute=""
                for index, elem in zip(list(isText),aux_line[list(isText)]):
                    value_text_without_name_feaute = value_text_without_name_feaute + elem + ','
                    value_text = value_text + name_features[index].strip() + ':' + elem + ','
                value['text'] = value_text[:-1]
                value['text_without_name_feature'] = value_text_without_name_feaute[:-1]
                value[name_features[0]]=aux_line[0]
                colection.insert(value)
            except Exception as e:
                print(aux_line)
                print(value)
                print(e)
                break
            lengthDB += 1
    index = IndexModel([('index', ASCENDING)], unique=True)
    colection.create_indexes([index])

